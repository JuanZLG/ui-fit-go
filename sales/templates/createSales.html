{% extends "baseInterface.html" %}
{% block title %} Agregar Proveedor {% endblock %}
{% block body %}

<h1 class="h1 mx-5 text-gray-800">Crear venta</h1>
<br>
<div class="container">
    <div class="card shadow mb-4">
        <div class="card-header py-4">
            <form id="venta-form" method="post">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-5 mb-3">
                        <label class="mb-2">Documento del Cliente *</label>
                        <input type="text" class="form-control" id="documento" name="documento" autocomplete="off"
                            placeholder="Documento">
                        <div class="d-flex p-2">
                            <label class="text-secondary me-2" id="mess-sugges-doc">Sugerencias:</label>
                        </div>
                        <span class="error-message" id="documento-error"></span>
                    </div>
                </div>
                <div id="cont-dom" class="mb-5">
                    <hr>
                    <div class="row ">
                        <div class="col-md-3 ">
                            <label class="mb-2">Nombre del Producto *</label>
                            <input type="text" class="form-control" id="producto" name="producto" autocomplete="off"
                                placeholder="Producto">
                            <div class="d-flex p-2">
                                <label class="text-secondary me-2" id="mess-sugges-prod">Sugerencias:</label>
                            </div>
                            <span class="error-message" id="producto-error"></span>
                        </div>
                        <div class="col-md-2 ">
                            <div class="form-group">
                                <label class="mb-2">Precio Unitario</label>
                                <input type="text" class="form-control" id="precioUnidad" name="precioUnidad" readonly>
                                <span class="error-message" id="precioU-error"></span>
                            </div>
                        </div>
                        <div class="col-md-2 ">
                            <div class="form-group">
                                <label class="mb-2">Cantidades *</label>
                                <input type="number" class="form-control" id="cantidad" name="cantidad"
                                    autocomplete="off" min="1" oninput="this.value = this.value.replace(/[^0-9]/g, '');"
                                    placeholder="Cantidad">
                            </div>
                        </div>
                        <div class="col-md-2 d-flex justify-content-center align-items-center">
                            <button class="btn btn-success" id="calcularTotal" type="button">Calcular Total =</button>
                        </div>
                        <div class="col-md-2 ">
                            <div class="form-group">
                                <label class="mb-2">TOTAL</label>
                                <input type="text" class="form-control" id="precioTotal" name="precioTotal" readonly>
                                <span class="error-message" id="total-error"></span>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
        <div class="row justify-content-end mt-3">
            <button class="btn btn-secondary" style="width: 200px;" id="agregarProducto" type="button">+ Agregar
                producto</button>
        </div>
    </div>

    <button class="btn btn-primary" type="submit">Crear Venta</button>
    </form>
</div>
</div>
</div>

<style>
    .sugerencia {
        display: flex;
        flex-direction: column;
        gap: 3px;
        width: 100%;
        color: #000;
        cursor: pointer;
    }

    .select {
        color: rgb(37, 37, 227);
    }

    .select:hover {
        color: rgb(17, 17, 120);
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    /********** DOCUMENTO ***********/
    $(document).ready(function () {
        $("#mess-sugges-doc").after('<div id="documento-suggestions"></div>');
        $("#documento").on("input", function () {
            var input = $(this).val();
            if (input.length >= 7) {
                $.ajax({
                    url: "{% url 'buscar_documentos' %}?q=" + input,
                    type: "GET",
                    success: function (data) {
                        var suggestions = $("#documento-suggestions");
                        suggestions.empty();
                        var documentSimilar = data.documentos[0];
                        var nombreCliente = data.nombre_cliente;
                        if (data.documentos.length > 0) {
                            suggestions.html("<span class='select'>" + documentSimilar + " / " + nombreCliente + "</span>");
                            suggestions.addClass("sugerencia").show();
                        } else {
                            suggestions.hide();
                        }
                    },
                    error: function () {
                        $("#documento-suggestions").empty().hide();
                    }
                });
            } else {
                $("#documento-suggestions").empty().hide();
            }
        });

        $(document).on("click", function (event) {
            if (!$(event.target).closest("#producto").length && !$(event.target).closest("#producto-suggestions").length) {
                $("#producto-suggestions").empty().hide();
            }
        });

        $("#documento-suggestions").on("click", "span", function () {
            $("#documento").val($(this).text());
            $("#documento-suggestions").empty().hide();
        });


        /********** PRODUCTO ***********/

        $("#mess-sugges-prod").after('<div id="producto-suggestions"></div>');
        $("#producto").on("input", function () {
            var input = $(this).val();
            if (input.length >= 4) {
                $.ajax({
                    url: "{% url 'buscar_productos' %}?q=" + input,
                    type: "GET",
                    success: function (data) {
                        var suggestions = $("#producto-suggestions");
                        suggestions.empty();
                        if (data.productos.length > 0) {
                            var producSimilar = data.productos[0];
                            suggestions.html("<span class='select'>" + producSimilar + "</span>");
                            suggestions.addClass("sugerencia").show();
                        } else {
                            suggestions.hide();
                        }
                    },
                    error: function () {
                        $("#producto-suggestions").empty().hide();
                    }
                });
            } else {
                $("#producto-suggestions").empty().hide();
            }
        });

        $("#producto-suggestions").on("click", "span.select", function () {
            var nombreProducto = $(this).text();
            $("#producto").val(nombreProducto);
            obtenerPrecioProducto(nombreProducto);
        });

        $("#producto-suggestions").on("click", "span", function () {
            $("#producto").val($(this).text());
            $("#producto-suggestions").empty().hide();
            $('#precioUnidad').removeClass('is-invalid');
            $('#precioU-error').empty();
        });



        /********** PRECIOS ***********/

        var timer;
        var isSearching = false;

        $("#producto").on("input", function () {
            clearTimeout(timer);
            if (!isSearching) {
                $('#precioUnidad').val("...");
            }
            var nombreProducto = $(this).val();
            if (nombreProducto.length >= 3) {
                timer = setTimeout(function () {
                    obtenerPrecioProducto(nombreProducto);
                }, 500);
            } else {
                $('#precioUnidad').removeClass('is-invalid');
                $('#precioU-error').empty();
                $('#precioUnidad').val("");
            }
        });

        function obtenerPrecioProducto(nombreProducto) {
            isSearching = true;
            $.ajax({
                url: "{% url 'obtener_precio_producto' %}",
                type: 'GET',
                data: {
                    nombre_producto: nombreProducto
                },
                success: function (data) {
                    isSearching = false;
                    if ('precio' in data) {
                        $('#precioUnidad').val(data.precio);
                    } else {
                        $('#precioUnidad').val("...");
                    }
                },
                error: function () {
                    isSearching = false;
                    $('#precioUnidad').addClass('is-invalid');
                    $('#precioU-error').text("Favor seleccionar el producto o verificar su registro").css('color', 'red');
                }
            });
        }


        $("#calcularTotal").on("click", function () {
            var precioUnidad = parseFloat($("#precioUnidad").val());
            var cantidad = parseFloat($("#cantidad").val());
            var error = $("#total-error");
            var precioTotal = $("#precioTotal");

            if (isNaN(precioUnidad) || isNaN(cantidad)) {
                precioTotal.addClass("is-invalid");
                error.text("Favor de llenar campos anteriores.").css('color', 'red');
                precioTotal.val("");
            }
            else {
                var total = precioUnidad * cantidad;
                var totalFormateado = total.toLocaleString(undefined, { minimumFractionDigits: 3 });
                precioTotal.val(totalFormateado);
                error.empty(); 
                precioTotal.removeClass('is-invalid');
        }
        });

        $(document).ready(function () {
            $("#precioTotal").val("");
            $("#precioUnidad").val("");
        });



     

        document.getElementById("agregarProducto").addEventListener("click", function () {
    var clon = $("#cont-dom").clone(); // Clonar el elemento
    clon.find('input[type="text"]').val(""); // Establecer los campos de texto a vacío
    clon.find('input[type="number"]').val(""); // Establecer los campos de número a vacío

    // Generar un nuevo ID para los elementos clonados
    clon.find('input').each(function () {
        var oldId = $(this).attr('id');
        var newId = oldId + "-clon";
        $(this).attr('id', newId);
    });

    // Agregar el elemento clonado al formulario
    $("#venta-form").append(clon);
});



    });

</script>




{% endblock %}