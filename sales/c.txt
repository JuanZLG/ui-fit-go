
# # @csrf_prot
# @csrf_exempt
# def editar_venta(request, id_venta):
#     if request.method == 'POST':
#         try:
#             data = json.loads(request.body)
#             documento = data.get('documento', '')
#             totalVenta = data.get('totalVenta', 0)
#             productos = data.get('productos', [])
#             # Validar que la venta exista
#             venta = Ventas.objects.get(id_venta=id_venta) 

#             if documento:
#                 cliente = Clientes.objects.get(documento=documento)
#                 venta.id_cliente = cliente
#             venta.totalVenta = totalVenta
#             venta.save()

#             for producto_datos in productos:
#                 nombre_producto = producto_datos.get('nombre', '')
#                 cantidad_vendida = producto_datos.get('cantidad', 0)

#                 if nombre_producto:
#                     # Obtener todos los detalles de venta relacionados con la venta
#                     detalles_venta = Detalleventa.objects.filter(id_venta=venta)
                    
#                     # Variable para rastrear si se encontró un detalle existente
#                     detalle_existente_encontrado = False

#                     for detalle in detalles_venta:
#                         # EN UN DETALLE PUEDEN HABER MÁS DE UN PRODUCTO CON EL MISMO NOMBRE 
#                         if detalle.id_producto.nombre_producto == nombre_producto:
#                             detalle.cantidad = cantidad_vendida
#                             detalle.precio_uni = producto_datos.get('precioUnidad', 0)
#                             detalle.precio_tot = producto_datos.get('precioTotal', 0)
#                             detalle.save()
#                             detalle_existente_encontrado = True
#                             break

#                     if not detalle_existente_encontrado:
#                         producto = Productos.objects.get(nombre_producto=nombre_producto)
#                         Detalleventa.objects.create(
#                             id_producto=producto,
#                             id_venta=venta,
#                             cantidad=cantidad_vendida,
#                             precio_uni=producto_datos['precioUnidad'],
#                             precio_tot=producto_datos['precioTotal']
#                         )

#             response_data = {'success': True}
#         except Exception as e:
#             response_data = {'success': False, 'error_message': str(e)}
#         return JsonResponse(response_data)

#     detalles = Detalleventa.objects.filter(id_venta=id_venta)
#     venta = get_object_or_404(Ventas, pk=id_venta)
#     return render(request, 'editSales.html', {"detalles": detalles, "venta": venta})


    
# @csrf_protect
@csrf_exempt
def editar_venta(request, id_venta):
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            documento = data.get('documento', '')
            totalVenta = data.get('totalVenta', 0)
            productos = data.get('productos', [])
            # Validar que la venta exista
            venta = Ventas.objects.get(id_venta=id_venta) 

            if documento:
                cliente = Clientes.objects.get(documento=documento)
                venta.id_cliente = cliente
            venta.totalVenta = totalVenta
            venta.save()

            # Eliminar todos los detalles relacionados con esta venta
            Detalleventa.objects.filter(id_venta=venta).delete()

            for producto_datos in productos:
                nombre_producto = producto_datos.get('nombre', '')
                cantidad_vendida = producto_datos.get('cantidad', 0)

            if nombre_producto:
                detalle = Detalleventa.objects.filter(id_venta=id_venta, id_producto__nombre_producto=nombre_producto).first()
                producto = Productos.objects.filter(nombre_producto=nombre_producto).first()
                Detalleventa.objects.filter(id=detalle.id).update(
                    id_producto=producto,
                    id_venta=venta,
                    cantidad=cantidad_vendida,
                    precio_uni=producto_datos['precioUnidad'],
                    precio_tot=producto_datos['precioTotal']
                )


            response_data = {'success': True}
        except Exception as e:
            response_data = {'success': False, 'error_message': str(e)}
        return JsonResponse(response_data)

    venta = Ventas.objects.get(id_venta=id_venta) 
    detalles = Detalleventa.objects.filter(id_venta=id_venta)
    return render(request, 'editSales.html', {"detalles": detalles, "venta": venta})


           