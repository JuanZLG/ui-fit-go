{% extends "baseInterface.html" %} 

{% block title %} Agregar Producto {% endblock %} 

{% block body %}
<center><h1 class="h3 text-gray-800 mb-4">Agregar Producto</h1></center>

<div class="card shadow">
  <div class="container p-4">
    <form class="form" id="producto-form" method="post">
      {% csrf_token %}
      
      <div class="form-row">
        <div class="col-md-6 mb-3">
          <div class="form-group">
            <label for="categoria">Categoría</label>
            <select class="form-select" aria-label="Default" name="iCategoria" id="iCategoria">
              {% for c in categorias %}
              <option value="{{ c.id_categoria }}">{{ c.nombre_categoria }}</option>
              {% endfor %}
            </select>
            <div class="error-message" id="iCategoria-error"></div>
          </div>
        </div>
  
        <div class="col-md-6 mb-3">
          <div class="form-group">
            <label>Marca</label>
            <select class="form-select" aria-label="Default select example" name="iMarca" id="iMarca">
              {% for m in marcas %}
              <option value="{{ m.id_marca }}">{{ m.nombre_marca }}</option>
              {% endfor %}
            </select>
            <div class="error-message" id="iMarca-error"></div>
          </div>
        </div>
      </div>
  
      <div class="form-group">
        <label>Nombre *</label>
        <input type="text" class="form-control" id="iNombre" name="iNombre" placeholder="Ingrese el nombre del producto"/>
        <div class="error-message" id="iNombre-error"></div>
      </div>
  
      <div class="form-group">
        <label for="descripcion">Descripción *</label>
        <textarea class="form-control" id="iDescripcion" name="iDescripcion" style="resize: vertical; max-height: 200px;" rows="4"></textarea>
        <div class="error-message" id="iDescripcion-error"></div>
      </div>
  
      <div class="form-row">
        <div class="col-md-3 mb-3">
            <div class="form-group">
                <label>Fecha de Vencimiento *</label>
                <input type="text" class="form-control" id="iFechaven" name="iFechaven" pattern="\d{4}-\d{2}-\d{2}" placeholder="AAAA-MM-DD" />
                <div class="error-message" id="iFechaven-error"></div>
            </div>
        </div>
      
        <div class="col-md-2 mb-3">
          <div class="form-group">
            <label for="cant">Cantidad *</label>
            <input type="number" class="form-control" id="iCantidad" name="iCantidad"/>
            <div class="error-message" id="iCantidad-error"></div>
          </div>
        </div>
      
        <div class="col-md-3 mb-3">
          <div class="form-group">
            <label for="sabor">Sabor *</label>
            <input type="text" class="form-control" id="iSabor" name="iSabor" placeholder="Sabor"/>
            <div class="error-message" id="iSabor-error"></div>
          </div>
        </div>
      
        <div class="col-md-2 mb-3">
          <div class="form-group">
            <label for="services">Servicios *</label>
            <input type="text" class="form-control" id="iServices" name="iServices" placeholder="Servicios"/>
            <div class="error-message" style="color:red;" id="iServices-error"></div>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="price">Precio del Producto *</label>
        <input type="number" class="form-control" id="iPrice" name="iPrice" placeholder="Ingrese un precio"/>
        <div class="error-message" id="iPrice-error"></div>
      </div>
  
      <div class="text-end">
        <button class="btn btn-success" type="submit" id="submit-button">Guardar</button>
      </div>

    </form>
  </div>
</div>

<script>
  var fechaActual = new Date().toISOString().split("T")[0];
  document.getElementById("iFechaven").min = fechaActual;
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
<script>
  $(document).ready(function () {
      $('#iCategoria, #iMarca, #iNombre, #iDescripcion, #iFechaven, #iCantidad, #iSabor, #iServices, #iPrice').on('change', function () {
          validarCampo($(this));
      });

      $('#producto-form').submit(function (event) {
          event.preventDefault();
          let errors = false;

          validarCampo($('#iCategoria'));
          validarCampo($('#iMarca'));
          validarCampo($('#iNombre'));
          validarCampo($('#iDescripcion'));
          validarCampo($('#iFechaven'));
          validarCampo($('#iCantidad'));
          validarCampo($('#iSabor'));
          validarCampo($('#iServices'));
          validarCampo($('#iPrice'));

          if ($('.error-message').text() === '') {
              $.ajax({
                  type: 'POST',
                  url: "{% url 'createAProduct' %}",
                  data: $(this).serialize(),
                  success: function (response) {
                      if (response.success) {
                          alert('Producto creado con éxito.');
                          window.location.href = "{% url 'productos' %}";
                      }
                  }
              });
          }
      });

      function mostrarError($campo, mensaje) {
          $campo.addClass('is-invalid');
          $campo.siblings('.error-message').text(mensaje);
      }

      function ocultarError($campo) {
          $campo.removeClass('is-invalid');
          $campo.siblings('.error-message').text('');
      }

      function validarCampo($campo) {
          const valor = $campo.val();
          if (!valor) {
              mostrarError($campo, 'Este campo es obligatorio.');
          } else {
              ocultarError($campo);
          }
      }
  });
</script>

{% endblock %}
