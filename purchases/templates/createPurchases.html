

{% extends "baseInterface.html" %}
{% block title %} Agregar Compra {% endblock %}
{% block body %}

<div class="row">
    <div class="col-md-5 mb-3">
        <h1 class="h2 mx-5">Crear compra</h1>
    </div>
    <div class="col-md-7 mb-3">
        <div class="row justify-content-end">
            <div class="col-md-7 mx-5 ">
                <div class="d-flex justify-content-between ">
                    <label class="mb-2">Obtener Proveedor *</label>
                    <div class='text-secondary d-flex gap-2' id="cont-docu"></div>
                </div>
                <input type="text" class="form-control" id="nombreProveedor" autocomplete="off"
                    placeholder="Ingrese el nombre del proveedor"
                    maxlength="100">
                <span class="error-message text-danger" id="error-docu"></span>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="card shadow mb-4">
        <div class="card-header ">
            <form id="compra-form" method="post">
                {% csrf_token %}
                <div class="cont-dom" class="mb-5">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Producto</th>
                                <th style="width: 20%;">Precio Unitario</th>
                                <th style="width: 15%;">Cantidad</th>
                                <th style="width: 20%;">Total del producto</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="producto-row">
                                <td class="p-2">
                                    <input type="text" class="form-control producto" name="producto" id="producto"
                                        autocomplete="off" placeholder="Nombre del producto">
                                    <span class="error-message text-danger error-produ"></span>
                                    <div class="p-2">
                                        <label class="text-secondary me-2 mess-sugges-prod">Sugerencias:</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-group">
                                        <input type="text" class="form-control precioUnidad" id="precioUnidad"
                                            name="precioUnidad" readonly>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-group">
                                        <input type="number" class="form-control cantidad" id="cantidad" name="cantidad"
                                            autocomplete="off" min="1"
                                            oninput="this.value = this.value.replace(/[^0-9]/g, '');"
                                            placeholder="Cantidad">
                                    </div>
                                </td>
                                <td>
                                    <div class="form-group">
                                        <input type="text" class="form-control precioTotal" id="precioTotal"
                                            name="precioTotal" readonly>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="cont-total-compra">
                        <div class="form-group">
                            <label for="totalCompra">Total de la
                                compra</label>
                            <input type="text" class="form-control" style="width: 200px;" id="totalCompra" readonly>
                        </div>
                        <div>
                            <button class="btn btn-agregar" id="agregar-producto" type="button">+
                                Agregar producto</button>
                        </div>
                    </div>
                </div>
                <div class="row cont-crear-compra">
                    <button class="btn btn-crear" type="submit">Crear Compra</button>
                </div>
            </form>
        </div>
    </div>
</div>
<style>
    .table{
        box-shadow: 0px 187px 75px rgba(0, 0, 0, 0.01), 0px 105px 63px rgba(0, 0, 0, 0.05), 0px 47px 47px rgba(0, 0, 0, 0.09), 0px 12px 26px rgba(0, 0, 0, 0.1), 0px 0px 0px rgba(0, 0, 0, 0.1);
    }

    .table thead {
        color: #26272d;
        text-align: center;
    }

    .producto-row {
        border-radius: 19px 19px 7px 7px;
    }

    .table td {
        padding-top: 30px !important;
    }

    .cont-total-compra {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding: 20px;
        background-color: #F2f2f2;
    }

    .cont-total-compra label {
        color: #1c3067;
        font-size: 1.2rem;
        margin-top: 2;
        font-weight: bold;
    }

    .btn-agregar {
        width: fit-content;
        min-width: 100px;
        height: 45px;
        padding: 8px;
        border-radius: 5px;
        border: 2.5px solid rgb(6, 14, 66);
        box-shadow: 0px 0px 20px -20px;
        cursor: pointer;
        color: #fff;
        background-color: #2c3e71;
        transition: all 0.2s ease-in-out 0ms;
        user-select: none;
        font-family: 'Poppins', sans-serif;
    }

    .btn-agregar:hover {
        background-color: #1c3067;
        color: #fff;
        box-shadow: 0px 0px 20px -18px;
    }

    .btn-agregar:active {
        transform: scale(0.95);
    }

    .eliminar-producto {
        position: relative;
        padding: 10px;
        text-align: center;
    }

    .eliminar-producto .icono-eliminar {
        position: absolute;
        top: 0;
        right: 0;
        width: 25px;
        background-color: #26272d;
        border-radius: 100%;
        color: #ffff;
    }

    .eliminar-producto:hover .icono-eliminar {
        animation: sacudir 0.3s ease-in 1;
        transform: translate(0);
    }

    @keyframes sacudir {
        0% {
            transform: translate(-2px, 2px);
        }

        100% {
            transform: translate(0);
        }
    }

    .cont-crear-compra {
        margin-top: 10px;
        height: 50px;
    }

    .btn-crear {
        color: #fff;
        width: 300px;
        background-color: #1c3067;
    }

    .btn-crear:hover {
        color: #fff;
        background-color: #0f1b3b;
    }
</style>
<style>
    .eliminar-producto:hover {
        cursor: pointer;
    }

    .fa-trash-can {
        color: #a60202;
        font-size: 24px;
        display: block;
        text-align: center
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-box-sizing: border-box;
    }

    .producto-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        padding: 0 10px;
        text-align: center;
    }

    .resultado-sugerencia:hover {
        cursor: pointer;
        opacity: 0.9;
    }


    .resultado-sugerencia {
        margin-right: 5px;
        padding: 2px 1rem;
        color: #f2f2f2;
        background-color: #0f1b3b;
        border-radius: 5px;
        font-size: 0.8rem;
    }

    .resultado-sugerencia-docu {
        margin-left: 10px;
        color: #f2f2f2;
        background-color: #6974d7;
        border-radius: 5px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
</style>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    /********** DOCUMENTO ***********/

    $(document).ready(function () {

$("#nombreProveedor").on("input", function () {
    let input = $(this).val();
    let resultadoDocu = $("#cont-docu");

    if (input.length >= 3) { // Puedes ajustar la longitud mínima requerida según tus necesidades
        $.ajax({
            url: "{% url 'buscar_proveedores' %}?q=" + input,
            type: "GET",
            success: function (data) {
                if (data.proveedores.length > 0) {
                    let nombreProveedor = data.proveedores[0];
                    resultadoDocu.html("<p id='nombreProveedorDato'>" + nombreProveedor + "</p>");
                    $("#nombreProveedor").addClass("is-valid");
                } else {
                    resultadoDocu.empty();
                }
            },
            error: function () {
                $("#nombreProveedor").addClass("is-invalid");
            }
        });
    } else {
        resultadoDocu.empty().hide(); // Limpiar y ocultar cont-docu
        $("#nombreProveedor").removeClass("is-valid is-invalid"); // Remover clases de validación
    }
});

function validarProveedor(nombreProveedor) {
    return new Promise(function (resolve, reject) {
        $.ajax({
            url: "{% url 'validar_proveedor' %}",
            type: 'GET',
            data: {
                nombreProveedor: nombreProveedor
            },
            success: function (data) {
                if (data.existe) {
                    resolve(true);
                } else {
                    resolve(false);
                }
            },
            error: function () {
                reject(new Error("Error al validar el proveedor"));
            },
        });
    });
}




        /********** PRODUCTO ***********/
        $(".mess-sugges-prod").after('<div class="producto-suggestions"></div>');
        $(document).on("input", ".producto", function () {
            let input = $(this).val();
            if (input.length >= 4) {
                let currentRow = $(this).closest("tr");
                $.ajax({
                    url: "{% url 'buscar_productos' %}?q=" + input,
                    type: "GET",
                    success: function (data) {
                        let suggestions = currentRow.find(".producto-suggestions");
                        suggestions.empty();
                        data.productos = data.productos.map(producto => producto.toUpperCase());
                        if (data.productos.length > 0) {
                            let producSimilar1 = data.productos[0];
                            let producSimilar2 = data.productos[1];
                            let producSimilar3 = data.productos[2];
                            suggestions.html("<span class='resultado-sugerencia'>" + producSimilar1);
                            if (data.productos.length > 1) {
                                suggestions.append("</span><span class='resultado-sugerencia'>" + producSimilar2 + "</span>")
                            } if (data.productos.length > 2) {
                                suggestions.append("</span><span class='resultado-sugerencia'>" + producSimilar3 + "</span>")
                            }

                            suggestions.addClass("sugerencia").show();
                        } else {
                            suggestions.hide();
                        }
                    },
                    error: function () {
                        currentRow.find(".producto-suggestions").empty().hide();
                    }
                });
            } else {
                $(this).closest("tr").find(".producto-suggestions").empty().hide();

            }
        });

        $(document).on("click", function (event) {
            if (!$(event.target).closest(".producto").length && !$(event.target).closest(".producto-suggestions").length) {
                $(".producto-suggestions").empty().hide();
            }
        });

        $(document).on("click", ".producto-suggestions span.resultado-sugerencia", function () {
            let currentRow = $(this).closest("tr");
            let nombreProducto = $(this).text();
            nombreProducto = nombreProducto.charAt(0).toUpperCase() + nombreProducto.slice(1).toLowerCase();
            currentRow.find(".producto").val(nombreProducto);

            validarProducto(currentRow, nombreProducto);
        });

        $(document).on("click", ".producto-suggestions span", function () {
            let currentRow = $(this).closest("tr");
            let nombreProducto = $(this).text();
            nombreProducto = nombreProducto.charAt(0).toUpperCase() + nombreProducto.slice(1).toLowerCase();
            currentRow.find(".producto").val(nombreProducto);
            currentRow.find(".producto-suggestions").empty().hide();
            currentRow.find('.precioUnidad').removeClass('is-invalid');
        });

        /********** PRECIOS ***********/
        $(document).on("input", ".producto", function () {
            let currentRow = $(this).closest("tr");
            let nombreProducto = $(this).val();
            currentRow.find(".error-produ").text(""); // Limpiar mensaje de error
            if (nombreProducto.length >= 3) {
                // Validar el producto antes de obtener el precio
                validarProducto(currentRow, nombreProducto);
            } else {
                currentRow.find('.cantidad, .precioTotal, .precioUnidad').val("");
                calcularTotalCompra();
            }
        });

        function validarProducto(currentRow, nombreProducto) {
            $.ajax({
                url: "{% url 'validar_producto' %}",
                type: 'GET',
                data: {
                    nombre_producto: nombreProducto
                },
                success: function (data) {
                    if (data.existe) {
                        obtenerPrecioProducto(currentRow, nombreProducto);
                    } else {
                        currentRow.find('.cantidad, .precioTotal, .precioUnidad').val("");
                    }
                },
                error: function () {
                    currentRow.find('.cantidad, .precioTotal').val("");
                }
            });
        }

        function obtenerPrecioProducto(currentRow, nombreProducto) {
            $.ajax({
                url: "{% url 'obtener_precio_producto' %}",
                type: 'GET',
                data: {
                    nombre_producto: nombreProducto
                },
                success: function (data) {
                    if ('precio' in data) {
                        let precioU = currentRow.find('.precioUnidad').val(parseFloat(data.precio).toLocaleString(undefined, {
                            minimumFractionDigits: 0,
                        }));
                    } else {
                        currentRow.find('.precioUnidad').addClass('is-invalid');
                    }
                },
                error: function () {
                    currentRow.find('.cantidad, .precioTotal').val("");
                }
            });
        }
        $(document).ready(function () {
            $(".precioTotal").val("");
            $(".precioUnidad").val("");
            $("#totalCompra").val("");
        });

        $(document).on("input", ".cantidad", function () {
            calcularTotalProducto($(this));
        });
        function calcularTotalProducto(inputCantidad) {
            let currentRow = inputCantidad.closest("tr");
            let precioUnidad = parseFloat(currentRow.find('.precioUnidad').val());
            let cantidad = parseFloat(inputCantidad.val());

            if (!isNaN(precioUnidad) && !isNaN(cantidad)) {
                let total = precioUnidad * cantidad;
                let totalProductoFormateado = total.toLocaleString(undefined, {
                    minimumFractionDigits: 3
                });
                currentRow.find('.precioTotal').val(totalProductoFormateado);
                calcularTotalCompra();
            } else {
                currentRow.find('.precioTotal').val("");
                calcularTotalCompra();
            }
        };


        $(document).on("click", ".eliminar-producto", function () {
            currentRow = $(this).closest("tr.producto-row").remove();
            calcularTotalCompra();
        });

        $("#agregar-producto").on("click", function () {
            let nuevaFila = '<tr class="producto-row">' +
                '<td>' +
                '<input type="text" class="form-control producto" name="producto" id="producto" autocomplete="off" placeholder="Nombre del producto">' +
                '<span class="error-message text-danger error-produ" ></span>' +
                '<div class="p-2">' +
                '<label class="text-secondary me-2 mess-sugges-prod">Sugerencias:</label>' +
                '</div>' +
                '<span class="error-message producto-error"></span>' +
                '</td>' +
                '<td>' +
                '<div class="form-group">' +
                '<input type="text" class="form-control precioUnidad" id="precioUnidad" name="precioUnidad" readonly>' +
                '<span class="error-message" id="precioU-error"></span>' +
                '</div>' +
                '</td>' +
                '<td>' +
                '<div class="form-group">' +
                '<input type="number" class="form-control cantidad" id="cantidad" name="cantidad" autocomplete="off" min="1" oninput="this.value = this.value.replace(/[^0-9]/g, \'\');" placeholder="Cantidad">' +
                '</div>' +
                '</td>' +
                '<td>' +
                '<div class="form-group">' +
                '<input type="text" class="form-control precioTotal" id="precioTotal" name="precioTotal" readonly>' +
                '<span class="error-message" id="total-error"></span>' +
                '</div>' +
                '<td class="eliminar-producto"><span class="icono-eliminar">X</span></td>' +
                '</td>';
            +
                '</tr>';
            // <i class="fa-x fa-xl icono-eliminar"></i>
            let filaAgregada = $(nuevaFila);
            $("tbody").append(filaAgregada);

            // Inicializa las sugerencias en la fila recién agregada
            inicializarSugerenciasEnFila(filaAgregada);
        });


        function inicializarSugerenciasEnFila(fila) {
            fila.find(".mess-sugges-prod").after('<div class="producto-suggestions"></div>');
        }

        function calcularTotalCompra() {
    let totalCompra = 0;

    $(".producto-row").each(function () {
        let precioTotal = parseFloat($(this).find('.precioTotal').val().replace(',', ''));

        if (!isNaN(precioTotal)) {
            totalCompra += precioTotal;
        }
    });
    let totalCompraFormateado = totalCompra.toLocaleString(undefined, {
        minimumFractionDigits: 3
    });

    $('#totalCompra').val('$ ' + totalCompraFormateado);
}

    });

</script>
<script>
    $(document).ready(function () {
        function validarCamposLlenos() {
            let camposLlenos = true;
        
            const productos = [];

            const proveedorValue = $('#nombreProveedor').val(); // Cambia al campo del proveedor

if (!proveedorValue) {
    mostrarError("#nombreProveedor");
    $('#error-docu').text("El campo del proveedor no puede estar vacío. Por favor, ingrésalo correctamente.");
    camposLlenos = false;
}  return camposLlenos;
    }

            $('.producto-row').each(function (index) {
                const row = $(this);
                const productoInput = row.find('.producto');
                const cantidadInput = row.find('.cantidad');
                const precioUnidad = row.find('.precioUnidad').val();
                const precioUnidadInput = row.find('.precioUnidad');
                const precioTotalInput = row.find('.precioTotal');

                const productoValue = productoInput.val();
                const precioUnidadValue = parseFloat(precioUnidadInput.val());
                const precioTotalValue = parseFloat(precioTotalInput.val());
                const cantidadValue = parseFloat(cantidadInput.val());

                if (!precioUnidadValue) {
                    productoInput.addClass('is-invalid');
                    row.find(".error-produ").text("Por favor, selecciona un producto válido para completar el registro.")
                    camposLlenos = false;
                }

                if (!productoValue) {
                    mostrarError(productoInput);
                    camposLlenos = false;
                }

                if (!cantidadValue) {
                    mostrarError(cantidadInput);
                    camposLlenos = false;
                }
                else {
                    productos.push({
                        nombre: productoValue,
                        precioUnidad: precioUnidadValue,
                        precioTotal: precioTotalValue,
                        cantidad: cantidadValue
                    });
                }
            });

            return camposLlenos ? { productos: productos } : null;
    

        function mostrarError(selector) {
            $(selector).addClass('is-invalid');

            $('#nombreProveedor, .producto, .cantidad').on('input', function () {
                const campo = $(this);
                $("#error-docu").text("");
                if (campo.val()) {
                    campo.removeClass('is-invalid');
                }
            });
        }

        $('#compra-form').submit(function (event) { // Cambia el evento y el formulario a 'compra-form'
    event.preventDefault();

    const data = validarCamposLlenos();
    if (!data) {
        return;
    }

    $.ajax({
    type: 'POST',
    url: "{% url 'crear_compra' %}",
    data: JSON.stringify(data),
    contentType: 'application/json',
    success: function (response) {
        console.log(response); // Agregar console.log para ver la respuesta en la consola

        if (response.success) {
            alert('Compra creada con éxito.');
            window.location.href = "{% url 'purchases' %}";
        }
    },
    error: function (xhr, status, error) {
        console.error(xhr.responseText); // Agregar console.error para ver los errores en la consola
        // Puedes mostrar un mensaje de error aquí si lo deseas
    }
});
})
});

</script>
{% endblock %}