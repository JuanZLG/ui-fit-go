{% extends "baseInterface.html" %}

{% block title %} Dashboard {% endblock %}

{% block body %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.7.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
    .card {
        border: none;
        background-color: #fff;
        padding: 0px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
    }


    .card-body {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
    }

    .card-value {
        font-size: 28px;
        font-weight: bold;
        color: #555;
    }

    .card-icon {
        font-size: 36px;
        margin-right: 15px;
        color: #888;
    }


    .chart-area {
        display: flex;
        justify-content: center;
        align-items: center;
        height: auto;
        border-radius: 10px;
        padding: 0;
        margin: 0;
        position: relative;
        max-width: 100%;
    }

    #graficolindo {
        width: 100%;
        max-width: 100%;
        height: 100%;
    }

    #myPieChart {
        width: 70%;
        height: 70%;
    }
</style>
<div class="container">
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100">
                <div class="card-body" data-toggle="modal" data-target="#pedidosEnProcesoModal">
                    <div>
                        <div class="card-title text-warning">Pedidos Pendientes</div>
                        <div id="pedidos-en-proceso" class="card-value text-gray-800">Actualizando...</div>
                    </div>
                    <i class="fas fa-exclamation-circle card-icon text-warning"></i>
                </div>
            </div>
        </div>
        <script>
            function actualizarContadorPedidosEnProceso() {
                $.ajax({
                    url: "{% url 'contar_pedidos_en_proceso' %}",
                    method: "GET",
                    success: function (data) {
                        const pedidosEnProceso = data.pedidos_en_proceso;
                        $("#pedidos-en-proceso").text(pedidosEnProceso);
                    },
                    error: function (error) {
                        console.error('Error al obtener el número de pedidos en proceso:', error);
                    }
                });
            }

            setInterval(actualizarContadorPedidosEnProceso, 5000);

            actualizarContadorPedidosEnProceso();
        </script>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100">
                <div class="card-body" data-toggle="modal" data-target="#totalMargenGanancia">
                    <div>
                        <div class="card-title text-danger">Margen de Ganancia</div>
                        <div id="margen-ganancia" class="card-value text-gray-800">Actualizando...</div>
                    </div>
                    <i class="fas fa-chart-line card-icon text-danger"></i>
                </div>
            </div>
        </div>
        
        <script>
            $(document).ready(function () {
                $.ajax({
                    url: "{% url 'obtener_margen_ganancia' %}",
                    type: 'GET',
                    success: function (data) {
                        const margenGanancia = parseFloat(data.margen_ganancia_total);
        
                        if (!isNaN(margenGanancia)) {
                            const formatter = new Intl.NumberFormat('es-CO', {
                                style: 'currency',
                                currency: 'COP',
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0,
                            });
                            const margenGananciaFormatted = formatter.format(margenGanancia);
                            $('#margen-ganancia').text(margenGananciaFormatted);
                        } else {
                            console.error('Error: El valor recibido no es un número válido.');
                        }
                    },
                    error: function () {
                        console.error('Error al obtener el margen de ganancia');
                    }
                });
            });
        </script>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100">
                <div class="card-body">
                    <div>
                        <div class="card-title text-primary">Total de Compras</div>
                        <div id="total-compras" class="card-value text-gray-800">Actualizando...</div>
                    </div>
                    <i class="fas fa-shopping-bag card-icon text-primary"></i>
                </div>
            </div>
        </div>


        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100">
                <div class="card-body">
                    <div>
                        <div class="card-title text-success">Total de Ventas</div>
                        <div id="total-ventas" class="card-value text-gray-800">Cargando...</div>
                    </div>
                    <i class="fas fa-dollar-sign card-icon text-success"></i>
                </div>
            </div>
        </div>

        <script>
            function actualizarValorEnCartaCompras(totalCompras) {
                const totalComprasFormatted = totalCompras.toLocaleString('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                });
                $('#total-compras').text(totalComprasFormatted);
            }

            function actualizarValorEnCartaVentas(totalVentas) {
                const totalVentasFormatted = totalVentas.toLocaleString('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                });
                $('#total-ventas').text(totalVentasFormatted);
            }

            $(document).ready(function () {
                $.ajax({
                    url: "{% url 'calcular_total_compras_y_ventas' %}",
                    method: "GET",
                    success: function (data) {
                        var totalComprasPorMes = data.total_compras_por_mes;
                        var totalVentasPorMes = data.total_ventas_por_mes;
                        var totalCompras = 0;
                        totalComprasPorMes.forEach(function (total) {
                            totalCompras += total.total_compras;
                        });
                        var totalVentas = 0;
                        totalVentasPorMes.forEach(function (total) {
                            totalVentas += total.total_ventas;
                        });
                        actualizarValorEnCartaCompras(totalCompras);
                        actualizarValorEnCartaVentas(totalVentas);
                    },
                    error: function (error) {
                        console.error('Error al obtener los totales de compras y ventas por mes:',
                            error);
                    }
                });
            });
        </script>

    </div>
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100">
                <div class="card-body">
                    <div>
                        <div class="card-title text-info">Usuarios</div>
                        <div id="usuarios-registrados" class="card-value text-gray-800">Cargando...</div>
                    </div>
                    <i class="fas fa-users card-icon text-info"></i>
                </div>
            </div>
        </div>

        <script>
            $(document).ready(function () {
                function actualizarUsuariosRegistrados() {
                    $.ajax({
                        url: "{% url 'obtener_usuarios_registrados' %}",
                        method: "GET",
                        success: function (data) {
                            if (data.error) {
                                console.error('Error:', data.error);
                            } else {
                                $('#usuarios-registrados').text(data.usuarios_registrados);
                            }
                        },
                        error: function (error) {
                            console.error('Error al obtener el número de usuarios registrados:', error);
                        }
                    });
                }
                actualizarUsuariosRegistrados();
                setInterval(actualizarUsuariosRegistrados, 300000);
            });
        </script>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-secondary shadow h-100">
                <div class="card-body">
                    <div>
                        <div class="card-title text-secondary">Proveedores</div>
                        <div id="numero-proveedores" class="card-value text-gray-800">Cargando...</div>
                    </div>
                    <i class="fas fa-truck card-icon text-secondary"></i>
                </div>
            </div>
        </div>
        <script>
            $(document).ready(function () {
                function actualizarNumeroProveedores() {
                    $.ajax({
                        url: "{% url 'obtener_numero_proveedores' %}",
                        method: "GET",
                        success: function (data) {
                            if (data.error) {
                                console.error('Error:', data.error);
                            } else {
                                $('#numero-proveedores').text(data.numero_proveedores);
                            }
                        },
                        error: function (error) {
                            console.error('Error al obtener el número de proveedores:', error);
                        }
                    });
                }
                actualizarNumeroProveedores();
                setInterval(actualizarNumeroProveedores, 300000);
            });
        </script>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100">
                <div class="card-body">
                    <div>
                        <div class="card-title text-info">Productos</div>
                        <div id="cantidad-productos" class="card-value text-gray-800">Cargando...</div>
                    </div>
                    <i class="fas fa-boxes card-icon text-info"></i>
                </div>
            </div>
        </div>
        <script>
            $(document).ready(function () {
                function actualizarCantidadProductos() {
                    $.ajax({
                        url: "{% url 'obtener_cantidad_productos' %}",
                        method: "GET",
                        success: function (data) {
                            if (data.error) {
                                console.error('Error:', data.error);
                            } else {
                                $('#cantidad-productos').text(data.cantidad_productos);
                            }
                        },
                        error: function (error) {
                            console.error('Error al obtener la cantidad de productos:', error);
                        }
                    });
                }
                actualizarCantidadProductos();
                setInterval(actualizarCantidadProductos, 300000);
            });
        </script>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100">
                <div class="card-body">
                    <div>
                        <div class="card-title text-success">Ventas</div>
                        <div id="ventas-hechas" class="card-value text-gray-800">Cargando...</div>
                    </div>
                    <i class="fas fa-hand-holding-usd card-icon text-success"></i>
                </div>
            </div>
        </div>
        <script>
            $(document).ready(function () {
                function actualizarVentasHechas() {
                    $.ajax({
                        url: "{% url 'obtener_ventas_hechas' %}",
                        method: "GET",
                        success: function (data) {
                            if (data.error) {
                                console.error('Error:', data.error);
                            } else {
                                $('#ventas-hechas').text(data.ventas_hechas);
                            }
                        },
                        error: function (error) {
                            console.error('Error al obtener las ventas hechas:', error);
                        }
                    });
                }
                actualizarVentasHechas();
                setInterval(actualizarVentasHechas, 300000);
            });
        </script>

    </div>


    <div class="row">
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4" style="height: 450px;">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
                    style="background-color: black; height: 55px;">
                    <h6 class="m-0 font-weight-bold text-white">Compras y Ventas</h6>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-light dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="#" data-value="semana">Última semana</a>
                            <a class="dropdown-item" href="#" data-value="mes">Último mes</a>
                            <a class="dropdown-item" href="#" data-value="ano">Último año</a>
                        </div>
                    </div>
                </div>
                <div class="card-body" style="padding: 10px;">
                    <div class="chart-area" style="height: 350px;">
                        <canvas id="graficolindo"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <script>
            $(document).ready(function () {
                var selectedValue = 'ano';
                function initializeAndRefreshChart(periodo) {
                    var ctx = document.getElementById("graficolindo").getContext("2d");
                    if (window.comprasVentasChart) {
                        window.comprasVentasChart.destroy();
                    }
                    window.comprasVentasChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Ventas',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                data: [],
                            },
                            {
                                label: 'Compras',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                data: [],
                            },
                            ],
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    actualizarGrafico(periodo);
                }
                function actualizarGrafico(periodo) {
                    $.ajax({
                        url: "{% url 'obtener_datos_ventas_y_compras' %}",
                        method: "GET",
                        data: {
                            periodo: periodo
                        },
                        success: function (data) {
                            window.comprasVentasChart.data.labels = data.labels;
                            window.comprasVentasChart.data.datasets[0].data = data.ventas;
                            window.comprasVentasChart.data.datasets[1].data = data.compras;
                            window.comprasVentasChart.update();
                        },
                        error: function (error) {
                            console.error('Error al obtener los datos de ventas y compras:', error);
                        }
                    });
                }

                initializeAndRefreshChart(selectedValue);
                $('.dropdown-item').on('click', function () {
                    selectedValue = $(this).data('value');
                    $('.btn--light-gray').text($(this).text());
                    actualizarGrafico(selectedValue);
                });
            });
        </script>

        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4" style="height: 450px;">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
                    style="background-color: black; height: 55px;">
                    <h6 class="m-0 font-weight-bold text-white">Productos y Cantidades</h6>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center" style="padding: 10px;">
                    <div class="chart-pie-container" style="height: 350px;">
                        <canvas id="myPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <script>
            function actualizarGraficoProductos() {
                if (window.myPieChart) window.myPieChart.destroy();

                $.ajax({
                    url: "{% url 'obtener_todos_los_productos' %}",
                    method: "GET",
                    success: function (data) {
                        var ctx = document.getElementById("myPieChart").getContext('2d');
                        var productos = data.productos;
                        var cantidades = data.cantidades;
                        var colores = [
                            '#71E565', '#FF5733', '#33FFBD', '#FF33A8', '#338AFF',
                            '#FF9E33', '#8E44AD', '#1ABC9C', '#E74C3C', '#3498DB',
                            '#F1C40F', '#2ECC71', '#E67E22', '#9B59B6', '#D35400',
                            '#C0392B', '#27AE60', '#2980B9', '#8E44AD', '#16A085'
                        ];

                        window.myPieChart = new Chart(ctx, {
                            type: 'pie',
                            data: {
                                datasets: [{
                                    data: cantidades,
                                    backgroundColor: colores,
                                }],
                                labels: productos
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                tooltips: {
                                    callbacks: {
                                        label: function (tooltipItem, data) {
                                            var dataset = data.datasets[0];
                                            var total = dataset.data.reduce((previousValue, currentValue) => previousValue + currentValue, 0);
                                            var currentValue = dataset.data[tooltipItem.index];
                                            var percentage = parseFloat(((currentValue / total) * 100).toFixed(2));
                                            return `${data.labels[tooltipItem.index]}: ${currentValue} unidades (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        });
                    },
                    error: function (error) {
                        console.error('Error al obtener los datos de productos y cantidades:', error);
                    }
                });
            }

            $(document).ready(function () {
                actualizarGraficoProductos();
            });
        </script>

    </div>
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4" style="height: 350px;">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
                    style="background-color: black; height: 55px;">
                    <h6 class="m-0 font-weight-bold text-white">Ventas por Producto</h6>
                </div>
                <div class="card-body" style="padding: 10px;">
                    <div class="chart-area" style="height: 275px;">
                        <canvas id="ventasPorProducto"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            function obtenerDatosVentasPorProducto() {
                $.ajax({
                    url: "{% url 'obtener_ventas_por_producto' %}",
                    method: "GET",
                    success: function (data) {
                        var ctx = document.getElementById("ventasPorProducto").getContext("2d");
                        window.ventasProductoChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.productos,  
                                datasets: [
                                    {
                                        label: 'Ventas de Productos',
                                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        borderWidth: 1,
                                        data: data.ventas, 
                                        fill: false  
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    },
                    error: function (error) {
                        console.error('Error al obtener los datos de ventas por producto:', error);
                    }
                });
            }

            obtenerDatosVentasPorProducto();
        });
    </script>


</div>

{% endblock %}