{% extends "baseInterface.html" %}

{% block title %} Agregar Cliente {% endblock %}
{% block body %}
<!-- Begin Page Content -->
<center>
    <h1 class="h3 text-gray-800 mb-4">Agregar Cliente</h1>
</center>

<div class="card shadow">
    <div class="container p-4">
        <form class="form" id="cliente-form" method="post">
            {% csrf_token %}
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="iDocumento">Documento *</label>
                    <input type="text" class="form-control" id="iDocumento" name="iDocumento" placeholder="Documento"
                        minlength="8" maxlength="10">
                    <div class="error-message" id="iDocumento-error"></div>
                    <div class="info-message" id="iDocumento-info" style="color:red;"></div>
                </div>

                <div class="form-group col-md-6">
                    <label for="iNombres">Nombres *</label>
                    <input type="text" class="form-control" id="iNombres" name="iNombres" placeholder="Nombres">
                    <div class="error-message" id="iNombres-error" style="color:red;"></div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="iApellidos">Apellidos *</label>
                    <input type="text" class="form-control" id="iApellidos" name="iApellidos" placeholder="Apellidos">
                    <div class="error-message" id="iApellidos-error" style="color:red;"></div>
                </div>
                <div class="form-group col-md-6">
                    <label for="iCelular">Celular *</label>
                    <div class="input-group">
                        <select class="form-control" id="iPais" name="iPais" onchange="actualizarCodigoLlamada(this)">
                            <option value="CO" selected>Colombia</option>
                            <option value="VE">Venezuela</option>
                            <option value="EC">Ecuador</option>
                        </select>
                        <input type="text" class="form-control" id="iCodigoLlamada" name="iCodigoLlamada" placeholder="+57" readonly>
                        <input type="text" class="form-control" id="iNumeroCelular" name="iNumeroCelular" placeholder="Número de celular" minlength="10" maxlength="10">
                    </div>
                    <div class="error-message" id="iNumeroCelular-error"></div>
                    <div class="info-message" id="iNumeroCelular-info"></div>
                </div>
                
                <script>
                function actualizarCodigoLlamada(select) {
                    const codigoLlamada = select.value === 'CO' ? '+57' : select.value === 'VE' ? '+58' : select.value === 'EC' ? '+593' : '';
                    document.getElementById('iCodigoLlamada').value = codigoLlamada;
                }
                </script>
                
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="iBarrio">Barrio *</label>
                    <input type="text" class="form-control" id="iBarrio" name="iBarrio" placeholder="Barrio">
                    <div class="error-message" id="iBarrio-error" style="color:red;"></div>
                </div>
                <div class="form-group col-md-6">
                    <label for="iDireccion">Dirección *</label>
                    <input type="text" class="form-control" id="iDireccion" name="iDireccion" placeholder="Dirección">
                    <div class="error-message" id="iDireccion-error" style="color:red;"></div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="departamento">Departamento *</label>
                    <select class="form-control" id="departamento" name="nombre_departamento">
                    </select>
                    <div class="error-message" id="departamento-error" style="color:red;"></div>
                </div>
                <div class="form-group col-md-6">
                    <label for="municipio">Municipio *</label>
                    <select class="form-control" id="municipio" name="nombre_municipio">
                        <option value="Municipio por Defecto">Selecciona un Municipio</option>
                    </select>
                    <div class="error-message" id="municipio-error" style="color:red;"></div>
                </div>
            </div>
            <div class="text-center">
                <p>(*) Campos Obligatorios</p>
            </div>
            <div class="text-end">
                <button class="btn btn-success" type="submit" id="submit-button" disabled>Guardar</button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Obtener la lista de departamentos al cargar la página
        obtenerDepartamentos();

        // Manejar cambios en el departamento seleccionado
        $("#departamento").change(function () {
            cargarMunicipios();
        });

        // ... (código anterior)

        $('#iDocumento').on('input', function () {
            validarDocumento();
            habilitarBoton();
        });

        $('#iCelular').on('input', function () {
            validarCelular();
            habilitarBoton();
        });

        // Cambiado el evento a 'input' para los otros campos
        $('#iNombres, #iApellidos, #iBarrio, #iDireccion, #departamento, #municipio').on('input', function () {
            validarCampo($(this));
            habilitarBoton();

        });
        $('#iDocumento, #iCelular, #iNombres, #iApellidos, #iBarrio, #iDireccion, #departamento, #municipio')
            .on('input', function () {
                if ($(this).val() === '') {
                    mostrarError($(this), 'Este campo es obligatorio.');
                } else {
                    ocultarError($(this));
                }
            });


        $('#cliente-form').submit(function (event) {
            event.preventDefault();
            let errors = false;

            // Validaciones en el lado del cliente para los campos que no han sido validados en tiempo real
            validarCampo($('#iNombres'));
            validarCampo($('#iApellidos'));
            validarCampo($('#iBarrio'));
            validarCampo($('#iDireccion'));
            validarCampo($('#departamento'));
            validarCampo($('#municipio'));

            // Envía el formulario si no hay errores
            if ($('.error-message').text() === '') {
                $.ajax({
                    type: 'POST',
                    url: "{% url 'agregarClientes' %}",
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.success) {
                            // Éxito: redirige o realiza acciones adicionales
                            alert('Cliente creado con éxito.');
                            window.location.href = "{% url 'Clientes' %}";
                        }
                    }
                });
            }
        });

        // ... (código anterior)
    });


    // Función para obtener la lista de departamentos
    function obtenerDepartamentos() {
        $.ajax({
            url: "https://www.datos.gov.co/resource/xdk5-pm3f.json",
            type: "GET",
            data: {
                "$limit": 5000,
            }
        }).done(function (data) {
            const departamentos = [...new Set(data.map(item => item.departamento))];
            const departamentoSelect = $("#departamento");
            departamentos.forEach(function (depto) {
                departamentoSelect.append($("<option>", {
                    value: depto,
                    text: depto
                }));
            });

            // Inicialmente, carga los municipios para el primer departamento en la lista
            cargarMunicipios();
        });
    }

    // Función para obtener la lista de municipios basados en el departamento seleccionado
    function obtenerMunicipios() {
        const departamentoSeleccionado = $("#departamento").val();
        const municipioSelect = $("#municipio");

        $.ajax({
            url: "https://www.datos.gov.co/resource/xdk5-pm3f.json",
            type: "GET",
            data: {
                "$limit": 5000,
                "departamento": departamentoSeleccionado
            }
        }).done(function (data) {
            municipioSelect.empty(); // Limpiar opciones anteriores
            data.forEach(function (item) {
                municipioSelect.append($("<option>", {
                    value: item.municipio,
                    text: item.municipio
                }));
            });
        });
    }

    // Función para cargar los municipios basados en el departamento seleccionado
    function cargarMunicipios() {
        obtenerMunicipios();
    }

    function mostrarError($campo, mensaje) {
        $campo.addClass('is-invalid');
        $campo.siblings('.error-message').text(mensaje);
    }

    function ocultarError($campo) {
        $campo.removeClass('is-invalid');
        $campo.siblings('.error-message').text('');
    }

    function mostrarInfo($campo, mensaje) {
        $campo.siblings('.info-message').text(mensaje);
    }

    function ocultarInfo($campo) {
        $campo.siblings('.info-message').text('');
    }


    function validarDocumento() {
        const documento = $('#iDocumento').val();
        const documentoError = /^\d{0,10}$/.test(documento) ? '' : 'Número de documento inválido.';

        $('#iDocumento').val(documento.replace(/\D/g, '')); // Elimina caracteres no numéricos
        $('#iDocumento-error').html(documentoError);


    }
    

    function validarCelular() {
        const celular = $('#iCelular').val();
        const celularError = /^\d{0,10}$/.test(celular) ? '' : 'Número inválido.';

        $('#iCelular').val(celular.replace(/\D/g, '')); // Elimina caracteres no numéricos
        $('#iCelular-error').html(celularError);


    }

    // Asociar funciones a eventos de cambio en los campos
    $('#iDocumento').on('input', validarDocumento);
    $('#iDocumento').on('keypress', validarDocumento);
    $('#iCelular').on('input', validarCelular);
    $('#iCelular').on('keypress', validarCelular);


    function validarCampo($campo) {
        const valor = $campo.val();
        if (!valor) {
            mostrarError($campo, 'Este campo es obligatorio.');
        } else {
            ocultarError($campo);
        }
    }

    function habilitarBoton() {
        const documento = $('#iDocumento').val();
        const celular = $('#iCelular').val();
        const nombres = $('#iNombres').val();
        const apellidos = $('#iApellidos').val();
        const barrio = $('#iBarrio').val();
        const direccion = $('#iDireccion').val();
        const departamento = $('#departamento').val();
        const municipio = $('#municipio').val();

        const documentoValido = (documento.length === 8 || documento.length === 10);
        const celularValido = (celular.length === 10);
        const camposCompletos = (nombres && apellidos && barrio && direccion && departamento && municipio);

        if (documentoValido && celularValido && camposCompletos) {
            $('#submit-button').prop('disabled', false);
        } else {
            $('#submit-button').prop('disabled', true);
        }
    }
</script>

{% endblock %}