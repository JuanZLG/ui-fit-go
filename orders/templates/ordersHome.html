{% extends "baseInterface.html" %}

{% block title %} Pedidos{% endblock %}

{% block body %}

<!-- <head>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/HomeVentas.css' %}">
</head> -->

<br>
<center>
    <h1 class="text-black-800 mb-4" style="font-weight:bold;">Gestion de Pedidos</h1>
</center>

<div class="card shadow mb-4">
    <div class="card-header py-4">
        <div class="table-responsive">
            <table class="table table-bordered  mx-auto text-center" id="dataTable" width="100%" cellspacing="3">
                <thead class="theads">
                    <tr>
                        <th>Cliente</th>
                        <th>Fecha de Registro</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pedido in pedidos %}
                    <tr class="{% if pedido.estado == 'cancelado' %}inactivo{% endif %}">
                        <td class="d-flex">{{ pedido.id_cliente.nombres }} {{ pedido.id_cliente.apellidos }}</td>
                        <td>{{ pedido.fecha_pedido }}</td>
                        <td>
                            <button
                                class="cambiar-estado-pedido {% if pedido.estado == 'cancelado' %}inactive-status{% elif pedido.estado == 'en proceso' %}en_proceso_pedido{% else %}active-status{% endif %}"
                                style="text-transform: capitalize;" data-pedido-id="{{ pedido.id_pedido }}">
                                {{ pedido.estado }}
                            </button>
                        </td>
                        <td class="cell-actions">
                            <button data-toggle="tooltip" data-placement="right" title="Ver Detalles" type="button"
                                class="btn btn-sm btn-primary  ml-2" data-pedido-id="{{ pedido.id_pedido }}">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}

                </tbody>
            </table>
        </div>
    </div>
</div>
</div>
<style>
    .cambiar-estado-pedido {
        width: 100px;
        border-radius: 3px;
        border: none;
        padding: 2px 5px;
    }

    .disable-btn-pedido {
        pointer-events: none;
        opacity: 0.8;
    }

    .inactive-status {
        background-color: #ec8080;
        color: #8a0404;
        opacity: 0.5;
        pointer-events: none;
        cursor: default;
    }
</style>
<script>
    document.querySelectorAll(".cambiar-estado-pedido").forEach(function (element) {
        if (element.textContent.trim() === 'en proceso') {
            element.addEventListener("click", function () {
                let pedidoId = element.getAttribute("data-pedido-id");
                let url = "{% url 'cambiarEstadoPedido' %}";

                Swal.fire({
                    title: 'Confirmación',
                    text: '¿Está seguro de que desea cancelar este pedido?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, cancelar',
                    cancelButtonText: 'No, mantener'
                }).then((result) => {
                    if (result.isConfirmed) {
                        cambiarEstadoPedido(pedidoId, url);
                    }
                });
            });
        }
    });

    function cambiarEstadoPedido(pedidoId, url) {
        $.ajax({
            url: url,
            data: { pedido_id: pedidoId },
            method: "GET",
            success: function (response) {
                if (response.status === 'success') {
                    location.reload();
                }
            },
            error: function () {
                Swal.fire('Error', 'Hubo un problema al cambiar el estado del pedido.', 'error');
            }
        });
    }




</script>

{% endblock %}